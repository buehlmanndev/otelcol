receivers:
  filelog:
    include:
      - /fixtures/*.log
      - /fixtures/*.json
    start_at: beginning
    operators:
      - id: container_input
        type: container
        format: containerd
        add_metadata_from_filepath: false
        output: log_router

      - id: log_router
        type: router
        default: cleanup_logtag
        routes:
          - expr: 'body matches "^\\s*\\{"'
            output: json_unescape_https
          - expr: 'body startsWith "ts="'
            output: kv_parse

      # JSON / ECS-like route
      - id: json_unescape_https
        type: regex_replace
        field: body
        regex: "\\\\https"
        replace_with: "https"
        if: 'body matches "\\\\https"'
        output: json_unescape_comma

      - id: json_unescape_comma
        type: regex_replace
        field: body
        regex: "\\\\,"
        replace_with: ","
        if: 'body matches "\\\\,"'
        output: json_parse

      - id: json_parse
        type: json_parser
        parse_from: body
        parse_to: attributes
        on_error: drop
        output: json_move_message

      - id: json_move_message
        type: move
        from: attributes.message
        to: body
        if: 'attributes.message != nil'
        output: json_flatten_log_level

      - id: json_flatten_log_level
        type: move
        from: attributes.log.level
        to: attributes["log.level"]
        if: 'attributes.log != nil && attributes.log.level != nil'
        output: json_flatten_log_logger

      - id: json_flatten_log_logger
        type: move
        from: attributes.log.logger
        to: attributes["log.logger"]
        if: 'attributes.log != nil && attributes.log.logger != nil'
        output: json_drop_log_map

      - id: json_drop_log_map
        type: remove
        field: attributes.log
        if: 'attributes.log != nil'
        output: json_flatten_thread

      - id: json_flatten_thread
        type: move
        from: attributes.process.thread.name
        to: attributes["process.thread.name"]
        if: 'attributes.process != nil && attributes.process.thread != nil && attributes.process.thread.name != nil'
        output: json_flatten_pid

      - id: json_flatten_pid
        type: move
        from: attributes.process.pid
        to: attributes["process.pid"]
        if: 'attributes.process != nil && attributes.process.pid != nil'
        output: json_drop_process_map

      - id: json_drop_process_map
        type: remove
        field: attributes.process
        if: 'attributes.process != nil'
        output: cleanup_logtag

      # Key-Value line route
      - id: kv_parse
        type: key_value_parser
        parse_from: body
        parse_to: attributes
        delimiter: "="
        pair_delimiter: ";"
        on_error: drop
        output: kv_trim_sev

      - id: kv_trim_sev
        type: regex_replace
        field: attributes.sev
        regex: "\\s+"
        replace_with: ""
        if: 'attributes.sev != nil'
        output: kv_strip_msg

      - id: kv_strip_msg
        type: regex_replace
        field: attributes.msg
        regex: '^\"|\"$'
        replace_with: ""
        if: 'attributes.msg != nil'
        output: kv_move_msg

      - id: kv_move_msg
        type: move
        from: attributes.msg
        to: body
        if: 'attributes.msg != nil'
        output: cleanup_logtag

      # Common cleanup (applies to all routes and default)
      - id: cleanup_logtag
        type: remove
        field: attributes.logtag
        if: 'attributes.logtag != nil'
        output: cleanup_log_file_path

      - id: cleanup_log_file_path
        type: remove
        field: attributes["log.file.path"]
        if: 'attributes["log.file.path"] != nil'
        output: cleanup_log_file_name

      - id: cleanup_log_file_name
        type: remove
        field: attributes["log.file.name"]
        if: 'attributes["log.file.name"] != nil'
        output: cleanup_log_iostream

      - id: cleanup_log_iostream
        type: remove
        field: attributes["log.iostream"]
        if: 'attributes["log.iostream"] != nil'
        output: cleanup_message_attribute

      - id: cleanup_message_attribute
        type: remove
        field: attributes.message
        if: 'attributes.message != nil'
        output: cleanup_msg_attribute

      - id: cleanup_msg_attribute
        type: remove
        field: attributes.msg
        if: 'attributes.msg != nil'

processors:
  batch: {}

exporters:
  file:
    path: /output/logs.json

service:
  pipelines:
    logs:
      receivers: [filelog]
      processors: [batch]
      exporters: [file]
